name: Node.js Package

on:
  push:
    branches:
      - extended-github-action

jobs:
  install-and-version:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
    permissions:
      contents: write  # Ensure GitHub Actions can push changes
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true # Ensures authentication works

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install PNPM
        run: npm install -g pnpm

      - name: Install Dependencies (Force Update Lockfile)
        run: pnpm install --no-frozen-lockfile

      - name: Install Changesets CLI in Workspace
        run: pnpm add -w -D @changesets/cli

      - name: Configure Git
        run: |
          git config --global user.name "ThilinaV98"
          git config --global user.email "thilinavithana98@gmail.com"
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Ensure .changeset Folder Exists
        run: |
          if [ ! -d ".changeset" ]; then pnpm changeset init; fi

      - name: Force Create a Changeset If None Exist
        id: check_changes
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "No detected changes. Creating an automatic changeset..."
            mkdir -p .changeset
            echo -e "---\n\"@thilinav98/digieye-types\": minor\n\"@thilinav98/digiex-types\": minor\n---\n\nAutomated version bump." > .changeset/auto-changeset.md
            git add .changeset
            git commit -m "chore: add automated changeset"
            echo "has_changes=true" >> $GITHUB_ENV
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "Changes detected, proceeding with versioning."
            echo "has_changes=true" >> $GITHUB_ENV
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Apply Version Changes (Changesets)
        id: apply_version
        run: |
          pnpm changeset version
          git add .
          git commit -m "chore: apply version bumps via changesets"
          git push origin extended-github-action
          echo "has_changes=true" >> $GITHUB_ENV
          echo "has_changes=true" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  build:
    needs: install-and-version
    runs-on: ubuntu-latest
    if: needs.install-and-version.outputs.has_changes == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install PNPM
        run: npm install -g pnpm

      - name: Install Dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run Build
        run: pnpm run build

  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://npm.pkg.github.com/

      - name: Install PNPM
        run: npm install -g pnpm

      - name: Install Dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Publish DigiEx Package (Force Publish)
        run: |
          cd packages/DigiEx
          pnpm publish --no-git-checks --registry=https://npm.pkg.github.com/ || echo "No changes detected"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Publish DigiEye Package (Force Publish)
        run: |
          cd packages/Digieye
          pnpm publish --no-git-checks --registry=https://npm.pkg.github.com/ || echo "No changes detected"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GH_TOKEN }}
